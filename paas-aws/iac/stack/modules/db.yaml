AWSTemplateFormatVersion: '2010-09-09'


Description: template for deploying the db instance


Parameters:
  DbName:
    Description: The name of the database
    Type: String

  DbUsername:
    Description: username to access the db
    Type: String

  DbPassword:
    Description: password to access the db
    Type: String

  DbSecGroupIds:
    Description: Security groups of the DB
    Type: List<AWS::EC2::SecurityGroup::Id>

  DbSubnetIds:
    Description: Subnet ids where db is deployed
    Type: List<AWS::EC2::Subnet::Id>


Resources:
  # ------------------------ RDS instance
  RDSSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Subnet group for the RDS db 
      DBSubnetGroupName: demo-cct-paas-db-subnet-group
      SubnetIds: !Ref DbSubnetIds

  RDSInstance:
    Type: AWS::RDS::DBInstance
    Properties:
      AllocatedStorage: '10'
      DBInstanceClass: 'db.t3.medium'
      DBInstanceIdentifier: 'demo-cct-paas-db'
      DBName: !Ref DbName
      DBSubnetGroupName: !Ref RDSSubnetGroup
      Engine: mysql
      EngineVersion: "8.4.4"
      MasterUsername: !Ref DbUsername
      MasterUserPassword: !Ref DbPassword
      Port: '3306'
      PubliclyAccessible: false
      VPCSecurityGroups: !Ref DbSecGroupIds


Outputs:
  Endpoint:
    Description: endpoint at which the db is exposed
    Value: !GetAtt RDSInstance.Endpoint.Address
